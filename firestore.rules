rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ---- Users ----
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

    // ---- Messages (server-mediated) ----
    match /messages/{messageId} {
      allow create: if false; // Only via Cloud Function
      allow read: if request.auth != null && (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
      allow update, delete: if false;
    }

    // ---- Audit Logs ----
    match /audit_logs/{logId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.performedBy;
      allow create, update, delete: if false; // Only Admin SDK
    }

    // ---- Tender Drafts ----
    // User scoped draft storage: drafts/{userId}/tenderDrafts/{draftId}
    match /drafts/{userId} {
      // Allow read/write to own drafts
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /tenderDrafts/{draftId} {
        // Explicit allow for draft documents
        allow read, write, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ---- Counters (tender number sequence) ----
    match /_counters/{counterId} {
      allow read: if request.auth != null; // Non-sensitive; allow reads
      allow write: if false; // Updated only by Cloud Function transactions
    }

    // ---- Tenders & Rate Analysis ----
    match /tenders/{tenderId} {
      // Read tender if current user is a member or admin
      allow get: if request.auth != null && (
        request.auth.token.role == 'admin' ||
        resource.data.membersMap[request.auth.uid] != null ||
        resource.data.createdBy == request.auth.uid
      );
      
      // Allow list queries - filtering done client-side or via membersMap
      allow list: if request.auth != null;
      
      // Allow tender updates by members with appropriate roles
      allow update: if request.auth != null && (
        request.auth.token.role == 'admin' ||
        resource.data.membersMap[request.auth.uid] in ['manager', 'editor', 'admin'] ||
        resource.data.createdBy == request.auth.uid
      );
      
      // Allow create for authenticated users
      allow create: if request.auth != null;
      
      // Only admins can delete
      allow delete: if request.auth != null && request.auth.token.role == 'admin';

      // Rate Analysis subcollection
      match /rateAnalysis/{raId} {
        allow get: if request.auth != null && (
          request.auth.token.role == 'admin' ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.membersMap[request.auth.uid] != null ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.createdBy == request.auth.uid
        );
        allow list: if request.auth != null;
        allow create, update: if request.auth != null && (
          request.auth.token.role == 'admin' ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.membersMap[request.auth.uid] in ['manager', 'editor', 'admin'] ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.createdBy == request.auth.uid
        );
        allow delete: if request.auth != null && request.auth.token.role == 'admin';
      }

      // Documents subcollection (metadata only; files in Storage)
      match /documents/{docId} {
        allow get: if request.auth != null && (
          request.auth.token.role == 'admin' ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.membersMap[request.auth.uid] != null ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.createdBy == request.auth.uid
        );
        allow list: if request.auth != null;
        allow create, update: if request.auth != null && (
          request.auth.token.role == 'admin' ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.membersMap[request.auth.uid] in ['manager', 'editor', 'admin'] ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.createdBy == request.auth.uid
        );
        allow delete: if request.auth != null && request.auth.token.role == 'admin';
      }

      // Status history subcollection
      match /statusHistory/{historyId} {
        allow get: if request.auth != null && (
          request.auth.token.role == 'admin' ||
          get(/databases/$(database)/documents/tenders/$(tenderId)).data.membersMap[request.auth.uid] != null
        );
        allow list: if request.auth != null;
        allow create, update, delete: if false; // Logged via CF
      }
    }

    // ---- Escalation Bill Module ----
    // Escalation Masters
    match /escalation_masters/{masterId} {
      // Allow authenticated users to read/write escalation masters
      allow read, list: if request.auth != null;
      allow create, update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Price Indices (shared data)
    match /price_indices/{indexId} {
      // Allow all authenticated users to read/write price indices
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // Escalation Bills
    match /escalation_bills/{billId} {
      // Allow authenticated users to read/write escalation bills
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // ---- Daily Work Status Module ----
    // DWS Projects
    match /dws_projects/{projectId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // DWS Personnel
    match /dws_personnel/{personnelId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // DWS Statuses
    match /dws_statuses/{statusId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // DWS Daily Entries
    match /dws_entries/{entryId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // DWS Users
    match /dws_users/{userId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // ---- Rate Analysis Sub-Modules ----
    // Master Rate Data
    match /masterRateData/{itemId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // SSR/DSR Data
    match /ssrDsrData/{itemId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // Catch-all deny for any other direct access
    match /{document=**} {
      allow get, list: if false;
      allow write: if false;
    }
  }
}
